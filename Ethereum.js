const Web3 = require('web3');
const lightwallet = require('eth-lightwallet');
var web3 = new Web3(new Web3.providers.HttpProvider("https://eth3.augur.net")); // Connect to the Augur Ethereum Endpoint

// Create an instance of the DAO contract
var DAO = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"proposals","outputs":[{"name":"recipient","type":"address"},{"name":"amount","type":"uint256"},{"name":"description","type":"string"},{"name":"votingDeadline","type":"uint256"},{"name":"executed","type":"bool"},{"name":"proposalPassed","type":"bool"},{"name":"numberOfVotes","type":"uint256"},{"name":"currentResult","type":"int256"},{"name":"proposalHash","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[{"name":"proposalNumber","type":"uint256"},{"name":"transactionBytecode","type":"bytes"}],"name":"executeProposal","outputs":[{"name":"result","type":"int256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"memberId","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"numProposals","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"members","outputs":[{"name":"member","type":"address"},{"name":"canVote","type":"bool"},{"name":"name","type":"string"},{"name":"memberSince","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"debatingPeriodInMinutes","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"minimumQuorum","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"targetMember","type":"address"},{"name":"canVote","type":"bool"},{"name":"memberName","type":"string"}],"name":"changeMembership","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"majorityMargin","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[{"name":"beneficiary","type":"address"},{"name":"etherAmount","type":"uint256"},{"name":"JobDescription","type":"string"},{"name":"transactionBytecode","type":"bytes"}],"name":"newProposal","outputs":[{"name":"proposalID","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"minimumQuorumForProposals","type":"uint256"},{"name":"minutesForDebate","type":"uint256"},{"name":"marginOfVotesForMajority","type":"int256"}],"name":"changeVotingRules","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"proposalNumber","type":"uint256"},{"name":"supportsProposal","type":"bool"},{"name":"justificationText","type":"string"}],"name":"vote","outputs":[{"name":"voteID","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"proposalNumber","type":"uint256"},{"name":"beneficiary","type":"address"},{"name":"etherAmount","type":"uint256"},{"name":"transactionBytecode","type":"bytes"}],"name":"checkProposalCode","outputs":[{"name":"codeChecksOut","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"inputs":[{"name":"minimumQuorumForProposals","type":"uint256"},{"name":"minutesForDebate","type":"uint256"},{"name":"marginOfVotesForMajority","type":"int256"},{"name":"congressLeader","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"proposalID","type":"uint256"},{"indexed":false,"name":"recipient","type":"address"},{"indexed":false,"name":"amount","type":"uint256"},{"indexed":false,"name":"description","type":"string"}],"name":"ProposalAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"proposalID","type":"uint256"},{"indexed":false,"name":"position","type":"bool"},{"indexed":false,"name":"voter","type":"address"},{"indexed":false,"name":"justification","type":"string"}],"name":"Voted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"proposalID","type":"uint256"},{"indexed":false,"name":"result","type":"int256"},{"indexed":false,"name":"quorum","type":"uint256"},{"indexed":false,"name":"active","type":"bool"}],"name":"ProposalTallied","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"member","type":"address"},{"indexed":false,"name":"isMember","type":"bool"}],"name":"MembershipChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"minimumQuorum","type":"uint256"},{"indexed":false,"name":"debatingPeriodInMinutes","type":"uint256"},{"indexed":false,"name":"majorityMargin","type":"int256"}],"name":"ChangeOfRules","type":"event"}]);
var contractInstance = DAO.at("0x013cc4a8a2fcd55025cd37b54a639b36b1f007ca");
// Create a new company on the DAO contract
var createCompany = function(minimumQuorumForProposals,minutesForDebate,marginOfVotesForMajority,congressLeader){
  console.log("Creating new DAO...");
  var dao = DAO.new(minimumQuorumForProposals,minutesForDebate,marginOfVotesForMajority,congressLeader,
   {
     from: congressLeader,
     data: '6060604052604051608080611ce9833981016040528080519060200190919080519060200190919080519060200190919080519060200190919050505b5b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b61007484848461034d565b6007600050805480919060010190908154818355818115116101775760030281600302836000526020600020918201910161017691906100af565b808211156101725760006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556000820160146101000a81549060ff021916905560018201600050805460018160011615610100020316600290046000825580601f10610120575061015d565b601f01602090049060005260206000209081019061015c919061013e565b80821115610158576000818150600090555060010161013e565b5090565b5b506002820160005060009055506003016100af565b5090565b5b505050506080604051908101604052806000815260200160018152602001604060405190810160405280600481526020017f4e69636b0000000000000000000000000000000000000000000000000000000081526020015081526020014281526020015060076000506000815481101561000257906000526020600020906003020160005b5060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060208201518160000160146101000a81548160ff021916908302179055506040820151816001016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102a157805160ff19168380011785556102d2565b828001600101855582156102d2579182015b828111156102d15782518260005055916020019190600101906102b3565b5b5090506102fd91906102df565b808211156102f957600081815060009055506001016102df565b5090565b50506060820151816002016000505590505080600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b505050506118c6806104236000396000f35b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156103a957610002565b8260016000508190555081600260005081905550806003600050819055507fa439d3fa452be5e0e1e24a8145e715f4fd8b9c08c96a42fd82a855a85e5d57de60016000505460026000505460036000505460405180848152602001838152602001828152602001935050505060405180910390a15b50505056606060405236156100d7576000357c010000000000000000000000000000000000000000000000000000000090048063013cf08b146100d9578063237e9492146101d55780633910682114610248578063400e3949146102745780635daf08ca1461029757806369bd3436146103705780638160f0b5146103935780638da5cb5b146103b65780639644fcbd146103ef578063aa02a90f14610457578063b1050da51461047a578063bcca1fd31461053d578063d3c0715b14610567578063eceb2945146105e3578063f2fde38b14610668576100d7565b005b6100ef600480803590602001909190505061074c565b604051808a73ffffffffffffffffffffffffffffffffffffffff168152602001898152602001806020018881526020018781526020018681526020018581526020018481526020018381526020018281038252898181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156101be5780601f10610193576101008083540402835291602001916101be565b820191906000526020600020905b8154815290600101906020018083116101a157829003601f168201915b50509a505050505050505050505060405180910390f35b6102326004808035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050611607565b6040518082815260200191505060405180910390f35b61025e60048080359060200190919050506107fe565b6040518082815260200191505060405180910390f35b61028160048050506107f5565b6040518082815260200191505060405180910390f35b6102ad6004808035906020019091905050610819565b604051808573ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018060200183815260200182810382528481815460018160011615610100020316600290048152602001915080546001816001161561010002031660029004801561035e5780601f106103335761010080835404028352916020019161035e565b820191906000526020600020905b81548152906001019060200180831161034157829003601f168201915b50509550505050505060405180910390f35b61037d600480505061073a565b6040518082815260200191505060405180910390f35b6103a06004805050610731565b6040518082815260200191505060405180910390f35b6103c36004805050610680565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6104556004808035906020019091908035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610961565b005b6104646004805050610743565b6040518082815260200191505060405180910390f35b6105276004808035906020019091908035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050610d6b565b6040518082815260200191505060405180910390f35b610565600480803590602001909190803590602001909190803590602001909190505061088b565b005b6105cd6004808035906020019091908035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091905050611397565b6040518082815260200191505060405180910390f35b6106526004808035906020019091908035906020019091908035906020019091908035906020019082018035906020019191908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509090919050506112ef565b6040518082815260200191505060405180910390f35b61067e60048080359060200190919050506106a6565b005b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561070257610002565b80600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b50565b60016000505481565b60026000505481565b60036000505481565b60046000508181548110156100025790600052602060002090600a020160005b915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600101600050549080600201600050908060030160005054908060040160009054906101000a900460ff16908060040160019054906101000a900460ff16908060050160005054908060060160005054908060070160005054905089565b60056000505481565b60066000506020528060005260406000206000915090505481565b600760005081815481101561000257906000526020600020906003020160005b915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060000160149054906101000a900460ff169080600101600050908060020160005054905084565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156108e757610002565b8260016000508190555081600260005081905550806003600050819055507fa439d3fa452be5e0e1e24a8145e715f4fd8b9c08c96a42fd82a855a85e5d57de60016000505460026000505460036000505460405180848152602001838152602001828152602001935050505060405180910390a15b505050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156109c157610002565b6000600660005060008773ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050541415610c9c57600760005080549050600660005060008773ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005081905550600760005080548091906001019090815481835581811511610b3857600302816003028360005260206000209182019101610b379190610a70565b80821115610b335760006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556000820160146101000a81549060ff021916905560018201600050805460018160011615610100020316600290046000825580601f10610ae15750610b1e565b601f016020900490600052602060002090810190610b1d9190610aff565b80821115610b195760008181506000905550600101610aff565b5090565b5b50600282016000506000905550600301610a70565b5090565b5b5050509150815060806040519081016040528086815260200185815260200184815260200142815260200150600760005083815481101561000257906000526020600020906003020160005b5060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555060208201518160000160146101000a81548160ff021916908302179055506040820151816001016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610c2957805160ff1916838001178555610c5a565b82800160010185558215610c5a579182015b82811115610c59578251826000505591602001919060010190610c3b565b5b509050610c859190610c67565b80821115610c815760008181506000905550600101610c67565b5090565b505060608201518160020160005055905050610d0e565b600660005060008673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000505491508150600760005082815481101561000257906000526020600020906003020160005b509050838160000160146101000a81548160ff021916908302179055505b7f27b022af4a8347100c7a041ce5ccf8e14d644ff05de696315196faae8cd50c9b8585604051808373ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a15b5050505050565b600060006000600660005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050541480610e0b57506007600050600660005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005054815481101561000257906000526020600020906003020160005b5060000160149054906101000a900460ff16155b15610e1557610002565b60046000508054809190600101909081548183558181151161103d57600a0281600a02836000526020600020918201910161103c9190610e50565b808211156110385760006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000506000905560028201600050805460018160011615610100020316600290046000825580601f10610eb85750610ef5565b601f016020900490600052602060002090810190610ef49190610ed6565b80821115610ef05760008181506000905550600101610ed6565b5090565b5b5060038201600050600090556004820160006101000a81549060ff02191690556004820160016101000a81549060ff0219169055600582016000506000905560068201600050600090556007820160005060009055600882016000508054600082556002029060005260206000209081019061102d9190610f71565b808211156110295760006000820160006101000a81549060ff02191690556000820160016101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560018201600050805460018160011615610100020316600290046000825580601f10610fe2575061101f565b601f01602090049060005260206000209081019061101e9190611000565b8082111561101a5760008181506000905550600101611000565b5090565b5b5050600201610f71565b5090565b5b5050600a01610e50565b5090565b5b5050509150815060046000508281548110156100025790600052602060002090600a020160005b509050858160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555084816001016000508190555083816002016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106110f157805160ff1916838001178555611122565b82800160010185558215611122579182015b82811115611121578251826000505591602001919060010190611103565b5b50905061114d919061112f565b80821115611149576000818150600090555060010161112f565b5090565b5050858584604051808473ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018381526020018280519060200190808383829060006004602084601f0104600f02600301f150905001935050505060405180910390208160070160005081905550603c600260005054024201816003016000508190555060008160040160006101000a81548160ff0219169083021790555060008160040160016101000a81548160ff02191690830217905550600081600501600050819055507f646fec02522b41e7125cfc859a64fd4f4cefd5dc3b6237ca0abe251ded1fa88182878787604051808581526020018473ffffffffffffffffffffffffffffffffffffffff168152602001838152602001806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156112c85780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a1600182016005600050819055505b50949350505050565b6000600060046000508681548110156100025790600052602060002090600a020160005b509050848484604051808473ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018381526020018280519060200190808383829060006004602084601f0104600f02600301f15090500193505050506040518091039020816007016000505414915061138e565b50949350505050565b600060006000600660005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005054148061143757506007600050600660005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005054815481101561000257906000526020600020906003020160005b5060000160149054906101000a900460ff16155b1561144157610002565b60046000508581548110156100025790600052602060002090600a020160005b50905060018160090160005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1614156114ad57610002565b60018160090160005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908302179055508060050160008181505480929190600101919050555083156115295780600601600081815054809291906001019190505550611541565b80600601600081815054809291906001900391905055505b7fc34f869b7ff431b034b7b9aea9822dac189a685e0b015c7d1be3add3f89128e885853386604051808581526020018481526020018373ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156115ee5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a15b509392505050565b6000600060046000508481548110156100025790600052602060002090600a020160005b509050806003016000505442108061165157508060040160009054906101000a900460ff165b806116f557508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16816001016000505484604051808473ffffffffffffffffffffffffffffffffffffffff166c010000000000000000000000000281526014018381526020018280519060200190808383829060006004602084601f0104600f02600301f15090500193505050506040518091039020816007016000505414155b8061170b57506001600050548160050160005054105b1561171557610002565b60036000505481600601600050541315611819578060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16670de0b6b3a764000082600101600050540284604051808280519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156117c45780820380516001836020036101000a031916815260200191505b5091505060006040518083038185876185025a03f1925050505060018160040160006101000a81548160ff0219169083021790555060018160040160016101000a81548160ff02191690830217905550611850565b60018160040160006101000a81548160ff0219169083021790555060008160040160016101000a81548160ff021916908302179055505b7fd220b7272a8b6d0d7d6bcdace67b936a8f175e6d5c1b3ee438b72256b32ab3af84826006016000505483600501600050548460040160019054906101000a900460ff166040518085815260200184815260200183815260200182815260200194505050505060405180910390a15b509291505056',
     gas: 3000000
   }, function(err, contract){
    if(err){
      console.log("Error creating company",err);
    }
    else if (typeof contract.address !== 'undefined') {
      return 'Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash;
    }
    else if (typeof contract.address === 'undefined') {
      return 'Your DAO contract is being deployed... ' + contract.transactionHash;
    }
    else{
      console.log("Error creating company",contract);
    }
 })
};
// Handle a new proposal
var newProposal = function(beneficiary,etherAmount,jobDesc,transactionBytecode,transactionObject){
  console.log("Creating new proposal",beneficiary);
  contractInstance.newProposal(
    beneficiary,
    etherAmount,
    jobDesc,
    transactionBytecode,
    transactionObject,
    function(err, transactionHash){
      if(err || !transactionHash){
        console.log('Error creating proposal',err);
        return "There was an error creating your proposal";
      }
      else{
        console.log("Tabling proposal",transactionHash);
        return "Your new proposal is being tabled... " + transactionHash;
      }
    });
  contractInstance.ProposalAdded({}, function(err, result){
    if(err || !result){
      console.log('Error creating proposal',err);
      return "There was an error creating your proposal";
    }
    else{
      console.log("Proposal successful",result.transactionHash);
      return "Your proposal has been tabled! " + result.transactionHash;
    }
  });
};
// Handle a new vote
var handleVote = function(proposalNumber,supportsProposal,justificationText,transactionObject){
  contractInstance.vote(
    proposalNumber,
    supportsProposal,
    justificationText,
    transactionObject,
    function(err, transactionHash){
      if(err || !transactionHash){
        console.log('Error handling vote',err);
        return "There was an error casting your vote";
      }
      else{
        console.log("Vote successfully processed",transactionHash);
        return "Your vote is being processed..." + transactionHash;
      }
    });
  contractInstance.Voted({}, function(err, result){
    if(err || !result){
      console.log("Error voting",err);
      return "There was an error voting";
    }
    else{
      console.log("Vote successfully tabled",result.transactionHash);
      return "Your vote has been cast! " + result.transactionHash;
    }
  });
};
// Execute a Proposal
var executeProposal = function(proposalNumber,transactionBytecode,transactionObject){
  contractInstance.vote(
    proposalNumber,
    transactionBytecode,
    transactionObject,
    function(err, transactionHash){
      if(err || !transactionHash){
        console.log("Error executing proposal");
        return "There was an error executing your proposal";
      }
      else{
        console.log("Proposal successfully processed",transactionHash);
        return "Your proposal is being processed..." + transactionHash;
      }
    });
  contractInstance.Voted({}, function(err, result){
    if(err || !result){
      console.log("Error executing proposal",err);
      return "There was an error executing your proposal";
    }
    else{
      console.log("Proposal successfully executed",result.transactionHash);
      return "Your proposal has executed!" + result.transactionHash;
    }
  });
};
// Create a new Ethereum wallet
var secretSeed = lightwallet.keystore.generateRandomSeed(); // generate a new BIP32 12-word seed
// The seed is stored encrypted by a user-defined password
var password = process.env.walletPassword || 'testing';
lightwallet.keystore.deriveKeyFromPassword(password, function (err,pwDerivedKey) {
  var ks = new lightwallet.keystore(secretSeed,pwDerivedKey);
  // generate five new address/private key pairs
  // the corresponding private keys are also encrypted
  ks.generateNewAddress(pwDerivedKey,1);
  congressLeader = ks.getAddresses()[0];
  // Now set ks as transaction_signer in the hooked web3 provider
  // and you can start using web3 using the keys/addresses in ks!
  ks.passwordProvider = function (callback) {
    var pw = process.env.walletPassword || 'testing';
    callback(null, pw);
  };
  console.log("Congress Leader Address: ",congressLeader);
  // Create a new proposal (Testing)
  if(!err && congressLeader) {
    var minimumQuorumForProposals = 0;
    var minutesForDebate = 60;
    var marginOfVotesForMajority = 0;
    // createCompany(minimumQuorumForProposals,minutesForDebate,marginOfVotesForMajority,congressLeader);
    var beneficiary = congressLeader;
    var etherAmount = 0.001;
    var jobDesc = "Testing Proposal";
    var transactionBytecode = "";
    var transactionObject = {
      from: congressLeader,
      gas: 3000000
    };
    newProposal(beneficiary,etherAmount,jobDesc,transactionBytecode,transactionObject);
    //handleVote(proposalNumber,supportsProposal,justificationText,transactionObject);
    //executeProposal(proposalNumber,transactionBytecode,transactionObject);
  }
  else{
    console.log("Failed to get a valid ethereum account");
  }
});
